name: CI/CD - AutoOps Web App

concurrency:
  group: terraform-autoops
  cancel-in-progress: false

on:
  push:
    branches: [ "main" ]
    paths:
      - "app/**"
      - "infra/app/**"
      - ".github/workflows/deploy.yml"

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # ----------------------------
    # Checkout Code
    # ----------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # ----------------------------
    # AWS Auth via OIDC
    # ----------------------------
    - name: Configure AWS credentials via OIDC
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::605134452604:role/github-actions-autoops-role
        aws-region: us-east-1

    # ----------------------------
    # Terraform Setup
    # ----------------------------
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3

    - name: Terraform Init (Remote Backend)
      working-directory: terraform/app
      run: terraform init

    # ----------------------------
    # STEP 1: Create ECR Repository ONLY
    # ----------------------------
    - name: Terraform Apply (ECR only)
      working-directory: terraform/app
      run: terraform apply -target=aws_ecr_repository.autoops -auto-approve

    # ----------------------------
    # STEP 2: Login to Amazon ECR
    # ----------------------------
    - name: Login to Amazon ECR
      uses: aws-actions/amazon-ecr-login@v2

    # ----------------------------
    # STEP 3: Build & Push Docker Image
    # ----------------------------
    - name: Build & Push Docker Image
      run: |
        ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        ECR_REPO="${ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/autoops-web"

        docker build -t autoops-web -f app/Dockerfile .
        docker tag autoops-web:latest ${ECR_REPO}:latest
        docker push ${ECR_REPO}:latest

    # ----------------------------
    # STEP 4: Apply Remaining Terraform (App Runner, IAM, etc.)
    # ----------------------------
    - name: Terraform Apply (Full Infra)
      working-directory: terraform/app
      run: terraform apply -auto-approve

    # ----------------------------
    # STEP 5: Output App Runner URL
    # ----------------------------
    - name: Fetch App Runner Service URL
      run: |
        aws apprunner list-services \
          --query "ServiceSummaryList[?ServiceName=='autoops-web-app'].ServiceUrl" \
          --output text
